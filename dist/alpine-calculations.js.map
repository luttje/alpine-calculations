{"version":3,"file":"alpine-calculations.js","sources":["../src/index.js","../builds/cdn.js"],"sourcesContent":["/**\n * AlpineJS Calculator Plugin\n *\n * A lightweight plugin for dynamic calculations in AlpineJS applications.\n * Provides directives for seamless reactive calculations.\n */\n\nconst ATTRIBUTE_NAME_SCOPE = 'x-calculator-scope';\n\n/**\n * Configuration settings\n */\nconst config = {\n  /**\n   * Default handler for NaN values.\n   */\n  handleNaN: (value) => value,\n\n  /**\n   * Default attribute name for locale override\n   */\n  localeAttribute: 'x-calculator-locale',\n};\n\n/**\n * Parses a localized number string as a float using the current locale.\n *\n * @param {string} str - The localized number string to parse\n * @param {string} [locale] - Optional locale string (defaults to current locale)\n * @returns {number} The parsed float number or NaN if parsing fails\n */\nfunction parseLocaleNumber(str, locale) {\n  if (typeof str !== 'string') {\n    return NaN;\n  }\n\n  // Trim whitespace\n  str = str.trim();\n  if (str === '') {\n    return NaN;\n  }\n\n  // Get locale-specific formatting info\n  const formatter = new Intl.NumberFormat(locale);\n  const parts = formatter.formatToParts(1234.5);\n\n  // Extract decimal and group separators from the locale\n  const decimalSep = parts.find(part => part.type === 'decimal')?.value || '.';\n  const groupSep = parts.find(part => part.type === 'group')?.value || ',';\n\n  // Handle negative numbers\n  const isNegative = str.startsWith('-') || str.startsWith('+');\n  const sign = str.startsWith('-') ? -1 : 1;\n  if (isNegative) {\n    str = str.substring(1);\n  }\n\n  let cleanStr = str;\n\n  // Escapes special regex characters\n  const escapeRegex = /[.*+?^${}()|[\\]\\\\]/g;\n  const regexEscape = (s) => s.replace(escapeRegex, '\\\\$&');\n\n  // Remove group separators (thousands separators)\n  if (groupSep !== decimalSep) {\n    // Handle the case where input might have regular spaces but locale uses non-breaking spaces\n    // or vice versa. We'll try to remove both the expected separator and common alternatives\n    const separatorsToRemove = [groupSep, '\\u00A0', ' ', '\\u2009', '\\u2005'];\n\n    for (const sep of separatorsToRemove) {\n      const escapedSep = regexEscape(sep);\n      const regex = new RegExp(escapedSep, 'g');\n\n      cleanStr = cleanStr.replace(regex, '');\n    }\n  }\n\n  // Convert decimal separator to standard dot\n  if (decimalSep !== '.') {\n    const escapedDecimalSep = regexEscape(decimalSep);\n\n    // Check for multiple decimal separators (invalid)\n    const decimalMatches = cleanStr.match(new RegExp(escapedDecimalSep, 'g'));\n    if (decimalMatches && decimalMatches.length > 1) {\n      return NaN;\n    }\n\n    cleanStr = cleanStr.replace(new RegExp(escapedDecimalSep, 'g'), '.');\n  } else {\n    // For standard dot decimal separator, check for multiple dots\n    const dotMatches = cleanStr.match(/\\./g);\n\n    if (dotMatches && dotMatches.length > 1) {\n      return NaN;\n    }\n  }\n\n  // Additional validation: empty string after cleaning should be NaN\n  if (cleanStr === '' || cleanStr === '.') {\n    return NaN;\n  }\n\n  // Parse the cleaned string\n  const result = parseFloat(cleanStr);\n\n  if (isNaN(result)) {\n    return NaN;\n  }\n\n  // Validate the result by checking if the cleaned string contains only valid characters\n  // Allow scientific notation (e/E) and basic number characters\n  if (!/^[0-9]*\\.?[0-9]*([eE][+-]?[0-9]+)?$/.test(cleanStr)) {\n    return NaN;\n  }\n\n  return result * sign;\n}\n\nfunction AlpineCalculator(Alpine) {\n  // Global registry to track all calculator sources\n  const sourceRegistry = new Map();\n  const expressionRegistry = new Map();\n\n  /**\n   * Retrieves all sources with a specific ID\n   *\n   * @param {string} id - The source ID to search for\n   * @returns {Array} Array of source objects\n   */\n  const getSourcesById = (id) => {\n    return Array.from(sourceRegistry.values())\n      .filter(source => source.id === id);\n  };\n\n  /**\n   * Sums all numeric values with a specific ID\n   *\n   * @param {string} id - The source ID to sum\n   * @returns {number} Sum of all values\n   */\n  const sumValuesWithId = (id) => {\n    return getSourcesById(id).reduce((sum, source) => {\n      const value = source.getValue() || 0;\n\n      return sum + value;\n    }, 0);\n  };\n\n  /**\n   * Finds sources within a specific scope element\n   *\n   * @param {Element} scopeElement - The scope boundary element\n   * @param {string} id - The source ID to search for\n   * @returns {Array} Array of scoped source objects\n   */\n  const getScopedSources = (scopeElement, id) => {\n    return Array.from(sourceRegistry.values()).filter(source =>\n      source.id === id && scopeElement.contains(source.element)\n    );\n  };\n\n  /**\n   * Gets the first scoped value by ID within a scope\n   *\n   * @param {Element} scopeElement - The scope boundary element\n   * @param {string} id - The source ID\n   * @returns {number} The first matching value or 0\n   */\n  const getScopedValue = (scopeElement, id) => {\n    const sources = getScopedSources(scopeElement, id);\n\n    return sources.length > 0\n      ? (sources[0].getValue() || 0)\n      : 0;\n  };\n\n  /**\n   * Traverses up the DOM tree to find the closest scope element\n   *\n   * @param {Element} element - Starting element\n   * @param {string} scopeSelector - CSS selector for scope boundary\n   * @returns {Element} The scope element or document\n   */\n  const findScope = (element, scopeSelector) => {\n    if (!scopeSelector)\n      return document;\n\n    let current = element;\n\n    while (current && current !== document) {\n      if (current.matches && current.matches(scopeSelector)) {\n        return current;\n      }\n\n      current = current.parentElement;\n    }\n\n    return document;\n  };\n\n  /**\n   * Creates an evaluation context with utility functions and scoped values\n   *\n   * @param {Element} scopeElement - The scope boundary element\n   * @returns {Object} Context object for expression evaluation\n   */\n  const createEvaluationContext = (scopeElement) => {\n    const context = { sumValuesWithId };\n\n    if (scopeElement !== document) {\n      // Scoped context: only include sources within this scope\n      const scopedSources = Array.from(sourceRegistry.values())\n        .filter(source => scopeElement.contains(source.element));\n      const sourceIds = new Set(scopedSources.map(source => source.id));\n\n      sourceIds.forEach(id => {\n        context[id] = getScopedValue(scopeElement, id);\n      });\n    } else {\n      // Global context: include all sources\n      const allSources = Array.from(sourceRegistry.values());\n      const sourceGroups = {};\n\n      allSources.forEach(source => {\n        const value = source.getValue() || 0;\n\n        if (!sourceGroups[source.id]) {\n          sourceGroups[source.id] = [];\n        }\n\n        sourceGroups[source.id].push(value);\n      });\n\n      // Add single values directly, arrays for multiple values\n      Object.entries(sourceGroups).forEach(([id, values]) => {\n        context[id] = values.length === 1\n          ? values[0]\n          : values;\n      });\n    }\n\n    return context;\n  };\n\n  /**\n   * Safely evaluates mathematical expressions with a limited context\n   *\n   * @param {string} expression - The expression to evaluate\n   * @param {Object} context - Variables and functions available to the expression\n   * @returns {number} Result of the expression or 0 on error\n   */\n  const evaluateExpression = (expression, context) => {\n    try {\n      const func = new Function(...Object.keys(context), `return ${expression}`);\n\n      return func(...Object.values(context));\n    } catch (error) {\n      console.warn('Calculator expression evaluation error:', error);\n\n      return 0;\n    }\n  };\n\n  /**\n   * Triggers updates for expressions that depend on a source ID\n   *\n   * @param {string} id - The source ID that changed\n   * @param {Element} changedElement - The element that triggered the change\n   */\n  const triggerUpdatesForId = (id, changedElement = null) => {\n    for (const [element, expressionData] of expressionRegistry.entries()) {\n      if (expressionData.expression.includes(id)) {\n        // Check scope constraints\n        if (\n          changedElement\n          && expressionData.scopeElement\n          && expressionData.scopeElement !== document\n        ) {\n          if (!expressionData.scopeElement.contains(changedElement)) {\n            continue;\n          }\n        }\n\n        expressionData.update();\n      }\n    }\n  };\n\n  /**\n   * Triggers global recalculation (used when sources are removed)\n   */\n  const triggerGlobalRecalculation = () => {\n    // Update all expressions\n    for (const [element, expressionData] of expressionRegistry.entries()) {\n      expressionData.update();\n    }\n  };\n\n  /**\n   * Gets the locale override from an element's attribute\n   *\n   * @param {Element} element - The element to check for locale override\n   * @returns {string|undefined} The locale override or undefined if not set\n   */\n  const getLocaleOverride = (element) => {\n    // If the element has a locale override attribute, use it\n    let localeOverride = element.getAttribute(config.localeAttribute);\n\n    // If it has no locale override, check the scope\n    if (!localeOverride && element.hasAttribute(ATTRIBUTE_NAME_SCOPE)) {\n      const scopeSelector = element.getAttribute(ATTRIBUTE_NAME_SCOPE);\n      const scopeElement = findScope(element, scopeSelector);\n\n      localeOverride = scopeElement.getAttribute(config.localeAttribute);\n    }\n\n    // If still no locale override, check the body attribute which will return null if not set\n    if (!localeOverride) {\n      localeOverride = document.body.getAttribute(config.localeAttribute);\n    }\n\n    if (!localeOverride) {\n      return undefined;\n    }\n\n    return localeOverride;\n  }\n\n  /**\n   * Extracts numeric value from various element types\n   *\n   * @param {Element} element - The element to extract value from\n   * @returns {string|number} Raw value for parsing\n   */\n  const extractElementValue = (element) => {\n    let localeOverride = getLocaleOverride(element);\n\n    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {\n      // In JavaScript, the .value property of an `<input type=\"number\">` will always return\n      // a string in the standard format (using a dot as the decimal separator) regardless of\n      // the user's locale.\n      if (element.type === 'number') {\n        return parseFloat(element.value) || 0;\n      }\n\n      // For other input types, we must parse the value as a locale string\n      return parseLocaleNumber(element.value, localeOverride);\n    }\n\n    return parseLocaleNumber(element.textContent, localeOverride);\n  };\n\n  /**\n   * Updates element content with calculated result\n   *\n   * @param {Element} element - The element to update\n   * @param {*} result - The calculated result\n   * @param {number} [decimalPlaces] - Number of decimal places to fix\n   */\n  const updateElementContent = (element, result, decimalPlaces) => {\n    if (isNaN(result)) {\n      result = config.handleNaN(result);\n    }\n\n    let localeOverride = getLocaleOverride(element);\n    let formattedResult = typeof result === 'number'\n      ? (\n        decimalPlaces\n          ? result.toLocaleString(localeOverride, {\n            minimumFractionDigits: parseInt(decimalPlaces),\n            maximumFractionDigits: parseInt(decimalPlaces)\n          })\n          : result.toLocaleString(localeOverride)\n      )\n      : result;\n\n    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {\n      const isNumericInput = element.type === 'number';\n\n      if (isNumericInput) {\n        // For numeric inputs we must use en-US notation when setting it\n        formattedResult = decimalPlaces ?\n          result.toFixed(parseInt(decimalPlaces)) :\n          result;\n      }\n\n      element.value = formattedResult;\n    } else {\n      element.textContent = formattedResult;\n    }\n  };\n\n  /**\n   * Directive: x-calculator-source\n   *\n   * Marks elements as calculation sources and tracks their values\n   */\n  Alpine.directive('calculator-source', (el, { expression }, { cleanup }) => {\n    const sourceId = expression;\n\n    // Create an object used to interface with the source\n    const source = {\n      id: sourceId,\n      element: el,\n      getValue: () => extractElementValue(el)\n    };\n    sourceRegistry.set(el, source);\n\n    // Trigger global recalculation when new source is registered\n    // This ensures expressions that depend on sumValuesWithId get updated\n    triggerGlobalRecalculation();\n\n    // Set up event listeners for value changes on this source\n    const events = ['input', 'change', 'keyup'];\n    const updateHandler = () => triggerUpdatesForId(sourceId, el);\n\n    events.forEach(event => {\n      el.addEventListener(event, updateHandler);\n    });\n\n    // Cleanup when directive is removed\n    cleanup(() => {\n      sourceRegistry.delete(el);\n\n      // Detach event listeners\n      events.forEach(event => {\n        el.removeEventListener(event, updateHandler);\n      });\n\n      // Trigger global recalculation after source removal\n      // Delay a frame to make sure DOM cleanup is complete\n      setTimeout(() => {\n        triggerGlobalRecalculation();\n      }, 0);\n    });\n  });\n\n  /**\n   * Directive: x-calculator-expression\n   *\n   * Evaluates expressions and updates element content reactively\n   */\n  Alpine.directive('calculator-expression', (el, { expression }, { effect, cleanup }) => {\n    let scopeElement = document;\n\n    // Determine scope element so we can isolate the values on which this expression depends\n    if (el.hasAttribute(ATTRIBUTE_NAME_SCOPE)) {\n      const scopeSelector = el.getAttribute(ATTRIBUTE_NAME_SCOPE);\n\n      scopeElement = scopeSelector\n        ? findScope(el, scopeSelector)\n        : el;\n    } else {\n      // Traverse parents to find one that limits scope with x-calculator-scope\n      let current = el.parentElement;\n\n      while (current && current !== document) {\n        if (current.hasAttribute(ATTRIBUTE_NAME_SCOPE)) {\n          const scopeSelector = current.getAttribute(ATTRIBUTE_NAME_SCOPE);\n\n          scopeElement = scopeSelector\n            ? findScope(current, scopeSelector)\n            : current;\n\n          break;\n        }\n\n        current = current.parentElement;\n      }\n    }\n\n    const updateExpression = () => {\n      const context = createEvaluationContext(scopeElement);\n      const result = evaluateExpression(expression, context);\n\n      // Store previous value to detect changes\n      const previousValue = el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'\n        ? el.value\n        : el.textContent;\n\n      // Update element content\n      updateElementContent(el, result, el.getAttribute('x-calculator-precision'));\n\n      // If this element is also a source and its value changed, trigger cascading updates\n      const source = sourceRegistry.get(el);\n\n      if (source) {\n        const currentValue = el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'\n          ? el.value\n          : el.textContent;\n\n        if (currentValue !== previousValue) {\n          triggerUpdatesForId(source.id, el);\n        }\n      }\n    };\n\n    // Register expression for dependency tracking\n    expressionRegistry.set(el, {\n      expression,\n      update: updateExpression,\n      scopeElement\n    });\n\n    // Initial calculation\n    updateExpression();\n\n    // Set up reactive effect\n    effect(updateExpression);\n\n    // Cleanup when directive is removed\n    cleanup(() => {\n      expressionRegistry.delete(el);\n    });\n  });\n\n  /**\n   * Directive: x-calculator-scope\n   *\n   * Defines calculation scope boundaries for isolation\n   */\n  Alpine.directive('calculator-scope', (el, { expression }, { cleanup }) => {\n    // Store scope selector for reference\n    el._calculatorScope = expression;\n\n    // Cleanup when directive is removed\n    cleanup(() => {\n      delete el._calculatorScope;\n    });\n  });\n\n  Alpine.calculator = AlpineCalculator;\n\n  // Trigger an event that we're ready\n  const event = new CustomEvent('alpine:calculator:ready', {\n    detail: {\n      calculator: AlpineCalculator,\n    },\n  });\n  document.dispatchEvent(event);\n}\n\n// Configuration function for future extensibility\nAlpineCalculator.configure = (desiredConfig = {}) => {\n  if (typeof desiredConfig['handleNaN'] === 'function') {\n    // Allow custom handling of NaN values in expressions\n    config.handleNaN = desiredConfig.handleNaN;\n  }\n\n  if (typeof desiredConfig['localeAttribute'] === 'string') {\n    // Allow custom attribute name for locale overrides\n    config.localeAttribute = desiredConfig.localeAttribute;\n  }\n\n  return AlpineCalculator;\n};\n\nexport default AlpineCalculator;\n\nexport { parseLocaleNumber };\n","import calculations from '../src/index'\n\ndocument.addEventListener('alpine:initializing', () => {\n  calculations(window.Alpine)\n})\n"],"names":["ATTRIBUTE_NAME_SCOPE","config","handleNaN","value","localeAttribute","parseLocaleNumber","str","locale","NaN","trim","formatter","Intl","NumberFormat","parts","formatToParts","decimalSep","find","part","type","groupSep","isNegative","startsWith","sign","substring","cleanStr","escapeRegex","regexEscape","s","replace","separatorsToRemove","sep","escapedSep","regex","RegExp","escapedDecimalSep","decimalMatches","match","length","dotMatches","result","parseFloat","isNaN","test","AlpineCalculator","Alpine","sourceRegistry","Map","expressionRegistry","getSourcesById","id","Array","from","values","filter","source","sumValuesWithId","reduce","sum","getValue","getScopedSources","scopeElement","contains","element","getScopedValue","sources","findScope","scopeSelector","document","current","matches","parentElement","createEvaluationContext","context","scopedSources","sourceIds","Set","map","forEach","allSources","sourceGroups","push","Object","entries","evaluateExpression","expression","func","Function","keys","error","console","warn","triggerUpdatesForId","changedElement","expressionData","includes","update","triggerGlobalRecalculation","getLocaleOverride","localeOverride","getAttribute","hasAttribute","body","undefined","extractElementValue","tagName","textContent","updateElementContent","decimalPlaces","formattedResult","toLocaleString","minimumFractionDigits","parseInt","maximumFractionDigits","isNumericInput","toFixed","directive","el","cleanup","sourceId","set","events","updateHandler","event","addEventListener","delete","removeEventListener","setTimeout","effect","updateExpression","previousValue","get","currentValue","_calculatorScope","calculator","CustomEvent","detail","dispatchEvent","configure","desiredConfig","calculations","window"],"mappings":"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"}